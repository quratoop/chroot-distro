name: update distro

on:
  schedule:
    # Run every Sunday at 02:00 UTC
    - cron: '0 2 * * 0'
  workflow_dispatch:

env:
  # Currently supported distros
  DISTROS: "archlinux debian ubuntu ubuntu-lts fedora kali"
  # Architectures to skip (space-separated)
  SKIP_ARCHS: "x86_64 i686 i386"

jobs:
  process-distros:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up environment
      run: |
        sudo apt-get update
        sudo apt-get install -y wget curl jq xz-utils

    - name: Get existing release assets
      run: |
        # Get existing release info and asset URLs
        echo "Fetching existing release assets..."
        gh release view distro --json assets > existing_assets.json 2>/dev/null || echo '{"assets": []}' > existing_assets.json
        cat existing_assets.json
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Process distributions
      run: |
        set -e

        # Function to get SHA256 hash of existing asset
        get_existing_asset_hash() {
          local asset_name="$1"

          # Extract digest from the JSON, removing the 'sha256:' prefix
          local existing_hash=$(jq -r ".assets[] | select(.name == \"$asset_name\") | .digest" existing_assets.json | sed 's/^sha256://')

          if [[ "$existing_hash" != "null" && -n "$existing_hash" ]]; then
            echo "$existing_hash"
          else
            echo "not_found"
          fi
        }

        download_and_process() {
          local url="$1"
          local output_name="$2"
          local temp_file="temp_download"

          echo "Downloading: $url"
          if ! wget -q "$url" -O "$temp_file"; then
            echo "Failed to download $url"
            return 1
          fi

          # Check file type and convert if needed
          file_type=$(file "$temp_file" | cut -d: -f2)

          if [[ "$file_type" == *"XZ compressed"* ]]; then
            mv "$temp_file" "$output_name"
          elif [[ "$file_type" == *"gzip compressed"* ]]; then
            echo "Converting tar.gz to tar.xz..."
            gunzip -c "$temp_file" | xz -c > "$output_name"
            rm "$temp_file"
          elif [[ "$file_type" == *"POSIX tar archive"* ]]; then
            echo "Compressing tar to tar.xz..."
            xz -c "$temp_file" > "$output_name"
            rm "$temp_file"
          else
            echo "Unknown file format, keeping as is..."
            mv "$temp_file" "$output_name"
          fi

          echo "Processed: $output_name ($(du -h "$output_name" | cut -f1))"
          return 0
        }

        mkdir -p releases
        mkdir -p files_to_upload
        echo "" > files_changed.txt

        # Process distros
        for distro in $DISTROS; do
          echo "=== Processing $distro ==="

        #################################
        #     special case for kali     #
        #################################

          if [[ "$distro" == "kali" ]]; then
            echo "Processing Kali Linux (special case)"

            # Process aarch64 - Use consistent naming pattern
            output_file="releases/kali-latest-aarch64.tar.xz"
            asset_name="kali-latest-aarch64.tar.xz"

            if download_and_process "http://kali.download/nethunter-images/current/rootfs/kali-nethunter-rootfs-minimal-arm64.tar.xz" "$output_file"; then
              # Check if file content changed
              new_hash=$(sha256sum "$output_file" | cut -d' ' -f1)
              existing_hash=$(get_existing_asset_hash "$asset_name")

              echo "New hash: $new_hash"
              echo "Existing hash: $existing_hash"

              if [[ "$new_hash" != "$existing_hash" ]]; then
                cp "$output_file" "files_to_upload/"
                echo "$asset_name" >> files_changed.txt
                echo "✓ Kali aarch64 - Content changed, will upload"
              else
                echo "✓ Kali aarch64 - No changes, skipping upload"
              fi
            else
              echo "✗ Failed to download Kali aarch64"
            fi

            # Process arm - Use consistent naming pattern
            output_file="releases/kali-latest-arm.tar.xz"
            asset_name="kali-latest-arm.tar.xz"

            if download_and_process "http://kali.download/nethunter-images/current/rootfs/kali-nethunter-rootfs-minimal-armhf.tar.xz" "$output_file"; then
              # Check if file content changed
              new_hash=$(sha256sum "$output_file" | cut -d' ' -f1)
              existing_hash=$(get_existing_asset_hash "$asset_name")

              echo "New hash: $new_hash"
              echo "Existing hash: $existing_hash"

              if [[ "$new_hash" != "$existing_hash" ]]; then
                cp "$output_file" "files_to_upload/"
                echo "$asset_name" >> files_changed.txt
                echo "✓ Kali arm - Content changed, will upload"
              else
                echo "✓ Kali arm - No changes, skipping upload"
              fi
            else
              echo "✗ Failed to download Kali arm"
            fi

            continue
          fi

        #################################
        #  special case for ubuntu-lts  #
        #################################

          if [[ "$distro" == "ubuntu-lts" ]]; then
            echo "Processing Ubuntu LTS (special case)"

            ubuntu_rootfs_base_url="https://cdimage.ubuntu.com/ubuntu-base/releases"
            release="noble"

            # Process arm64 (aarch64)
            architecture="arm64"
            version=$(wget -qO- "${ubuntu_rootfs_base_url}/${release}/release/" | grep -oE "ubuntu-base-[0-9]+(\.[0-9]+)*-base-${architecture}\.tar\.gz" | head -n 1 | sed -E 's/ubuntu-base-([0-9]+(\.[0-9]+)*)-base-.*/\1/')

            if [[ -n "$version" ]]; then
              download_url="${ubuntu_rootfs_base_url}/${release}/release/ubuntu-base-${version}-base-${architecture}.tar.gz"
              output_file="releases/ubuntu-lts-latest-aarch64.tar.xz"
              asset_name="ubuntu-lts-latest-aarch64.tar.xz"

              echo "Found Ubuntu LTS version: $version for $architecture"

              if download_and_process "$download_url" "$output_file"; then
                new_hash=$(sha256sum "$output_file" | cut -d' ' -f1)
                existing_hash=$(get_existing_asset_hash "$asset_name")

                echo "New hash: $new_hash"
                echo "Existing hash: $existing_hash"

                if [[ "$new_hash" != "$existing_hash" ]]; then
                  cp "$output_file" "files_to_upload/"
                  echo "$asset_name" >> files_changed.txt
                  echo "✓ Ubuntu LTS aarch64 - Content changed, will upload"
                else
                  echo "✓ Ubuntu LTS aarch64 - No changes, skipping upload"
                fi
              else
                echo "✗ Failed to download Ubuntu LTS aarch64"
              fi
            else
              echo "✗ Failed to get Ubuntu LTS version for $architecture"
            fi

            # Process armhf (arm)
            architecture="armhf"
            version=$(wget -qO- "${ubuntu_rootfs_base_url}/${release}/release/" | grep -oE "ubuntu-base-[0-9]+(\.[0-9]+)*-base-${architecture}\.tar\.gz" | head -n 1 | sed -E 's/ubuntu-base-([0-9]+(\.[0-9]+)*)-base-.*/\1/')

            if [[ -n "$version" ]]; then
              download_url="${ubuntu_rootfs_base_url}/${release}/release/ubuntu-base-${version}-base-${architecture}.tar.gz"
              output_file="releases/ubuntu-lts-latest-arm.tar.xz"
              asset_name="ubuntu-lts-latest-arm.tar.xz"

              echo "Found Ubuntu LTS version: $version for $architecture"

              if download_and_process "$download_url" "$output_file"; then
                new_hash=$(sha256sum "$output_file" | cut -d' ' -f1)
                existing_hash=$(get_existing_asset_hash "$asset_name")

                echo "New hash: $new_hash"
                echo "Existing hash: $existing_hash"

                if [[ "$new_hash" != "$existing_hash" ]]; then
                  cp "$output_file" "files_to_upload/"
                  echo "$asset_name" >> files_changed.txt
                  echo "✓ Ubuntu LTS arm - Content changed, will upload"
                else
                  echo "✓ Ubuntu LTS arm - No changes, skipping upload"
                fi
              else
                echo "✗ Failed to download Ubuntu LTS arm"
              fi
            else
              echo "✗ Failed to get Ubuntu LTS version for $architecture"
            fi

            continue
          fi

        #################################
        #  rest uses the proot-distro   #
        #################################

          proot_distro_script_url="https://raw.githubusercontent.com/termux/proot-distro/master/distro-plugins/${distro}.sh"

          if ! curl -s "$proot_distro_script_url" -o "${distro}.sh"; then
            echo "Failed to download script for $distro, skipping..."
            continue
          fi

          if [[ $(head -1 "${distro}.sh") == *"404"* ]] || [[ ! -s "${distro}.sh" ]]; then
            echo "Script not found for $distro, skipping..."
            continue
          fi

          script_content=$(cat "${distro}.sh")
          DISTRO_DISPLAY_NAME="$distro"
          echo "Processing: $DISTRO_DISPLAY_NAME"

          echo "$script_content" | grep "^TARBALL_URL\[" | while IFS= read -r line; do
            arch=$(echo "$line" | sed -n "s/TARBALL_URL\['\([^']*\)'\].*/\1/p")
            url=$(echo "$line" | sed -n 's/.*="\([^"]*\)".*/\1/p')

            if [[ -n "$arch" && -n "$url" ]]; then
              # Check if architecture should be skipped
              skip_arch=false
              for skip in $SKIP_ARCHS; do
                if [[ "$arch" == "$skip" ]]; then
                  echo "Skipping architecture: $arch"
                  skip_arch=true
                  break
                fi
              done

              if [[ "$skip_arch" == true ]]; then
                continue
              fi

              output_file="releases/${DISTRO_DISPLAY_NAME}-latest-${arch}.tar.xz"
              asset_name="${DISTRO_DISPLAY_NAME}-latest-${arch}.tar.xz"

              echo "Found $arch: $url"

              if download_and_process "$url" "$output_file"; then
                # Check if file content changed
                new_hash=$(sha256sum "$output_file" | cut -d' ' -f1)
                existing_hash=$(get_existing_asset_hash "$asset_name")

                echo "New hash: $new_hash"
                echo "Existing hash: $existing_hash"

                if [[ "$new_hash" != "$existing_hash" ]]; then
                  cp "$output_file" "files_to_upload/"
                  echo "$asset_name" >> files_changed.txt
                  echo "✓ Successfully processed $arch for $DISTRO_DISPLAY_NAME - Content changed, will upload"
                else
                  echo "✓ Successfully processed $arch for $DISTRO_DISPLAY_NAME - No changes, skipping upload"
                fi
              else
                echo "✗ Failed to process $arch for $DISTRO_DISPLAY_NAME"
              fi
            fi
          done

          rm -f "${distro}.sh"
          echo ""
        done

        echo "=== Files to Upload ==="
        if [[ -d "files_to_upload" && $(ls -A files_to_upload/ 2>/dev/null) ]]; then
          ls -la files_to_upload/
          echo "Changed files:"
          cat files_changed.txt
        else
          echo "No files need to be uploaded (no changes detected)"
        fi

        echo "=== All Processed Files ==="
        if [[ -d "releases" && $(ls -A releases/ 2>/dev/null) ]]; then
          ls -la releases/
        else
          echo "No files were processed successfully"
          exit 1
        fi

    - name: Generate release body
      run: |
        cat > release_body.md << EOF
        ## Linux Distro Rootfs

        Updated: $(date -u '+%Y-%m-%d %H:%M:%S UTC')

        This release contains the latest Linux distribution archives from proot-distro or from the official sources

        ### Changes in this update:
        $(if [[ -s files_changed.txt ]]; then
          echo "Files updated:"
          while IFS= read -r file; do
            echo "- $file"
          done < files_changed.txt
        else
          echo "- No file changes detected in this run"
        fi)
        EOF

    - name: Create/Update Release
      if: hashFiles('files_to_upload/*') != ''
      uses: softprops/action-gh-release@v1
      with:
        tag_name: distro
        name: "Linux Distribution Archives"
        body_path: release_body.md
        files: files_to_upload/*
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Skip release update
      if: hashFiles('files_to_upload/*') == ''
      run: |
        echo "No files changed, skipping release update"
        cat release_body.md

    - name: Clean up
      run: |
        rm -rf releases/
        rm -rf files_to_upload/
        rm -f release_body.md
        rm -f existing_assets.json
        rm -f files_changed.txt
